https://chatgpt.com/share/69814211-9f18-8005-bd48-33205d108800 - this is complete chat for setup all error also included.


# Ansible + Docker Java 8 Automation Lab (macOS Apple Silicon)

This repository contains a **100% working, battle-tested Ansible lab** to practice **multi-server automation** using **Docker containers** on **macOS (Apple Silicon ‚Äì M2)**.

You can clone this repo anytime in the future and run it **without hitting SSH, Python, or Ansible version errors**.

---

## üñ•Ô∏è My Local Machine Details (Reference)

| Item                  | Value                            |
| --------------------- | -------------------------------- |
| OS                    | macOS (Apple Silicon)            |
| Chip                  | Apple M2                         |
| Ansible Version       | 2.20.x                           |
| Python (Control Node) | 3.14.x (Homebrew)                |
| Docker                | Docker Desktop for Mac           |
| Target OS             | Ubuntu 20.04 (Docker containers) |

> ‚ö†Ô∏è Docker Desktop on macOS **cannot access container IPs directly**. We **must use port mapping** (`localhost:2222`, `localhost:2223`).

---

## üß† Architecture

Mac (Ansible Control Node)
‚îú‚îÄ‚îÄ SSH ‚Üí localhost:2222 ‚Üí server1 (Ubuntu)
‚îî‚îÄ‚îÄ SSH ‚Üí localhost:2223 ‚Üí server2 (Ubuntu)

Java 8 is installed on both servers using **one Ansible playbook**.

---

## üìÅ Project Structure

```
ansible-docker-java/
‚îú‚îÄ‚îÄ ansible.cfg
‚îú‚îÄ‚îÄ inventory.ini
‚îî‚îÄ‚îÄ install_java8.yml
```

---

## üîß Step 1: Create Docker Servers

```bash
docker rm -f server1 server2

docker run -dit --name server1 -p 2222:22 ubuntu:20.04
docker run -dit --name server2 -p 2223:22 ubuntu:20.04
```

---

## üîê Step 2: Prepare Each Server (SSH + Python)

Run **for BOTH containers**:

```bash
docker exec -it server1 bash
apt update
apt install -y openssh-server python3 sudo nano
mkdir -p /run/sshd
chmod 755 /run/sshd
passwd root   # password = root
nano /etc/ssh/sshd_config
```

Add **at the end of the file**:

```
PermitRootLogin yes
PasswordAuthentication yes
```

Restart SSH:

```bash
service ssh restart
exit
```

Repeat same steps for `server2`.

---

## üîë Step 3: Test SSH (Must Work)

```bash
ssh root@localhost -p 2222
ssh root@localhost -p 2223
```

Password: `root`

---

## üì¶ Step 4: Install Required Tool on macOS

Ansible needs `sshpass` for password authentication:

```bash
brew install sshpass
```

---

## üìÑ ansible.cfg (IMPORTANT)

```ini
[defaults]
inventory = inventory.ini
host_key_checking = False
retry_files_enabled = False
timeout = 30

[ssh_connection]
pipelining = True
```

---

## üìÑ inventory.ini

```ini
[java_servers]
server1 ansible_host=127.0.0.1 ansible_port=2222
server2 ansible_host=127.0.0.1 ansible_port=2223

[java_servers:vars]
ansible_user=root
ansible_ssh_pass=root
ansible_python_interpreter=/usr/bin/python3
```

---

## üìÑ install_java8.yml (BOOTSTRAP-SAFE)

> ‚ö†Ô∏è Ubuntu 20.04 ships Python 3.8. Modern Ansible requires ‚â• 3.9.
> We **intentionally use the `raw` module** to avoid Python/apt conflicts.

```yaml
---
- name: Install Java 8 on Docker servers (bootstrap-safe)
  hosts: java_servers
  become: yes
  gather_facts: no

  tasks:
    - name: Update apt cache
      raw: apt-get update -y

    - name: Install Java 8
      raw: apt-get install -y openjdk-8-jdk

    - name: Verify Java installation
      raw: java -version
      register: java_output
      ignore_errors: yes

    - name: Print Java version
      debug:
        var: java_output.stdout
```

---

## ‚ñ∂Ô∏è Step 5: Run Ansible

```bash
ansible java_servers -m ping
ansible-playbook install_java8.yml
```

Expected output:

```
openjdk version "1.8.0_xxx"
```

---

## ‚úÖ Final Verification

```bash
docker exec -it server1 java -version
docker exec -it server2 java -version
```

---

## üèÜ What This Lab Teaches

* Ansible inventory & config precedence
* SSH on Docker (macOS-specific issues)
* Python compatibility in real environments
* Bootstrap automation using `raw`
* Multi-server idempotent automation

This setup mirrors **real DevOps production troubleshooting**.

---

## üöÄ Next Improvements (Optional)

* Convert to **Ansible Role**
* Make Java version configurable (8 / 11 / 17)
* Deploy Spring Boot JAR
* Replace passwords with SSH keys
* Trigger via CI/CD (GitHub Actions)

---

### Author

Abhinav Devkar

Happy Automating üöÄ
