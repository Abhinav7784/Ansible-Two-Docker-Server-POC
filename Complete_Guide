https://chatgpt.com/share/69814211-9f18-8005-bd48-33205d108800 - this is complete chat for setup all error also included.


# Ansible + Docker Java 8 Automation Lab (macOS Apple Silicon)

This repository contains a **100% working, battle-tested Ansible lab** to practice **multi-server automation** using **Docker containers** on **macOS (Apple Silicon â€“ M2)**.

You can clone this repo anytime in the future and run it **without hitting SSH, Python, or Ansible version errors**.

---

## ğŸ–¥ï¸ My Local Machine Details (Reference)

| Item                  | Value                            |
| --------------------- | -------------------------------- |
| OS                    | macOS (Apple Silicon)            |
| Chip                  | Apple M2                         |
| Ansible Version       | 2.20.x                           |
| Python (Control Node) | 3.14.x (Homebrew)                |
| Docker                | Docker Desktop for Mac           |
| Target OS             | Ubuntu 20.04 (Docker containers) |

> âš ï¸ Docker Desktop on macOS **cannot access container IPs directly**. We **must use port mapping** (`localhost:2222`, `localhost:2223`).

---

## ğŸ§  Architecture

Mac (Ansible Control Node)
â”œâ”€â”€ SSH â†’ localhost:2222 â†’ server1 (Ubuntu)
â””â”€â”€ SSH â†’ localhost:2223 â†’ server2 (Ubuntu)

Java 8 is installed on both servers using **one Ansible playbook**.

---

## ğŸ“ Project Structure

```
ansible-docker-java/
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ inventory.ini
â””â”€â”€ install_java8.yml
```

---

## ğŸ”§ Step 1: Create Docker Servers

```bash
docker rm -f server1 server2

docker run -dit --name server1 -p 2222:22 ubuntu:20.04
docker run -dit --name server2 -p 2223:22 ubuntu:20.04
```

---

## ğŸ” Step 2: Prepare Each Server (SSH + Python)

Run **for BOTH containers**:

```bash
docker exec -it server1 bash
apt update
apt install -y openssh-server python3 sudo nano   - 6 asia - 44 -kolkata
mkdir -p /run/sshd
chmod 755 /run/sshd
passwd root   # password = root
nano /etc/ssh/sshd_config
```

Add **at the end of the file**:

```
PermitRootLogin yes
PasswordAuthentication yes
```

ctrl + o + enter + ctrl + x

Restart SSH:

```bash
service ssh restart
exit
```

Repeat same steps for `server2`.

---

## ğŸ”‘ Step 3: Test SSH (Must Work)

```bash
ssh root@localhost -p 2222

if error come - solution

Perfect â€” this is **expected behavior**, not an error ğŸ‘
You didnâ€™t break anything. This happens **every time Docker containers are recreated**.

Letâ€™s fix it **cleanly and permanently**, and Iâ€™ll explain *why* it happens so youâ€™ll never be confused again.

---

## â— What this warning actually means

```
WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!
```

SSH is saying:

> â€œEarlier, I connected to something on `localhost:2222`.
> Now that thing has a **different SSH identity**.
> Iâ€™m stopping you to prevent a possible attack.â€

In your case:

* You **deleted and recreated Docker containers**
* New container = new SSH host key
* Port `2222` stayed the same
* SSH thinks something suspicious happened

ğŸ‘‰ This is **100% normal in Docker labs**

---

## âœ… SAFE FIX (Recommended way)

### ğŸ”¹ Remove old SSH key for this port

Run **on your Mac** (not inside container):

```bash
ssh-keygen -R "[localhost]:2222"
```

You should see something like:

```
Host [localhost]:2222 found: line 2
known_hosts updated.
```

---

### ğŸ”¹ Try SSH again

```bash
ssh root@localhost -p 2222
```

When prompted:

```
Are you sure you want to continue connecting (yes/no)?
```

Type:

```
yes
```

Enter password:

```
root
```

âœ… Youâ€™ll log in successfully.

---

## ğŸ” Do the same for server2 (important)

```bash
ssh-keygen -R "[localhost]:2223"
ssh root@localhost -p 2223
```

---

## ğŸ§  Why Ansible does NOT complain

You already configured:

```ini
host_key_checking = False
```

So:

* **Manual SSH** â†’ strict (secure)
* **Ansible** â†’ non-interactive, ignores host key changes

This is **best practice** for automation.

---

## ğŸ§¼ Optional: Clean all Docker SSH entries (one-time)

If you play a lot with containers:

```bash
sed -i '' '/localhost:222/d' ~/.ssh/known_hosts
```

(macOS-specific command)

---

## ğŸ† Professional takeaway

This exact issue happens in:

* CI/CD pipelines
* Rebuilt servers
* Autoscaling groups
* Blue/Green deployments

And the fix is **always**:

```
ssh-keygen -R <host>
```

You handled it like a pro ğŸ‘Œ

---
exit - from root

ssh root@localhost -p 2223
```

Password: `root`

---

## ğŸ“¦ Step 4: Install Required Tool on macOS

Ansible needs `sshpass` for password authentication:

```bash
brew install sshpass
```

---

## ğŸ“„ ansible.cfg (IMPORTANT)

```
[defaults]
inventory = inventory.ini
host_key_checking = False
retry_files_enabled = False
timeout = 30

[ssh_connection]
pipelining = True
ssh_args = -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
```

---

Createn three files inside -  mkdir ansible-docker - cd ansible-docker

## ğŸ“„ inventory.ini

```ini
[java_servers]
server1 ansible_host=127.0.0.1 ansible_port=2222
server2 ansible_host=127.0.0.1 ansible_port=2223

[java_servers:vars]
ansible_user=root
ansible_ssh_pass=root
```

---

## ğŸ“„ install_java8.yml (BOOTSTRAP-SAFE)

> âš ï¸ Ubuntu 20.04 ships Python 3.8. Modern Ansible requires â‰¥ 3.9.
> We **intentionally use the `raw` module** to avoid Python/apt conflicts.

```yaml
---
- name: Install Java 8 on Docker servers (bootstrap-safe)
  hosts: java_servers
  become: yes
  gather_facts: no

  tasks:
    - name: Update apt cache
      raw: apt-get update -y

    - name: Install Java 8
      raw: apt-get install -y openjdk-8-jdk

    - name: Verify Java installation
      raw: java -version
      register: java_output
      ignore_errors: yes

    - name: Print Java version
      debug:
        var: java_output.stdout
```

---

## â–¶ï¸ Step 5: Run Ansible

```bash
ansible java_servers -m ping -   do not use this command use this - ansible java_servers -m raw -a "whoami"

ansible-playbook install_java8.yml
```

Expected output:

```
openjdk version "1.8.0_xxx"
```

---

## âœ… Final Verification

```bash
docker exec -it server1 java -version
docker exec -it server2 java -version
```

---

## ğŸ† What This Lab Teaches

* Ansible inventory & config precedence
* SSH on Docker (macOS-specific issues)
* Python compatibility in real environments
* Bootstrap automation using `raw`
* Multi-server idempotent automation

This setup mirrors **real DevOps production troubleshooting**.

---

## ğŸš€ Next Improvements (Optional)

* Convert to **Ansible Role**
* Make Java version configurable (8 / 11 / 17)
* Deploy Spring Boot JAR
* Replace passwords with SSH keys
* Trigger via CI/CD (GitHub Actions)

---

### Author

Abhinav Devkar

Happy Automating ğŸš€
